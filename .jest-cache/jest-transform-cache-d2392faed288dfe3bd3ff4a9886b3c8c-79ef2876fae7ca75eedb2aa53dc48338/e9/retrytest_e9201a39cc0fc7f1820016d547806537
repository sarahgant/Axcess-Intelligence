866d7e67c278c58c04164daa382fa590
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock the logger to avoid console output during tests
jest.mock('../../src/core/logging/logger', () => ({
    logger: {
        debug: jest.fn(),
        info: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        fatal: jest.fn()
    }
}));
const retry_1 = require("../../src/core/utils/retry");
describe('RetryWithBackoff', () => {
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('Configuration', () => {
        it('should use default configuration when no config provided', () => {
            const retry = new retry_1.RetryWithBackoff();
            const config = retry.getConfig();
            expect(config.maxAttempts).toBe(3);
            expect(config.initialDelay).toBe(1000);
            expect(config.maxDelay).toBe(10000);
            expect(config.backoffMultiplier).toBe(2);
            expect(config.retryableErrors).toContain('NETWORK_ERROR');
            expect(config.retryableErrors).toContain('TIMEOUT');
        });
        it('should merge custom configuration with defaults', () => {
            const retry = new retry_1.RetryWithBackoff({
                maxAttempts: 5,
                initialDelay: 500
            });
            const config = retry.getConfig();
            expect(config.maxAttempts).toBe(5);
            expect(config.initialDelay).toBe(500);
            expect(config.maxDelay).toBe(10000); // Default
            expect(config.backoffMultiplier).toBe(2); // Default
        });
        it('should update configuration after creation', () => {
            const retry = new retry_1.RetryWithBackoff();
            retry.updateConfig({ maxAttempts: 10 });
            expect(retry.getConfig().maxAttempts).toBe(10);
        });
    });
    describe('Successful execution', () => {
        it('should return result immediately on success', async () => {
            const retry = new retry_1.RetryWithBackoff();
            const mockFn = jest.fn().mockResolvedValue('success');
            const result = await retry.execute(mockFn, 'test');
            expect(result).toBe('success');
            expect(mockFn).toHaveBeenCalledTimes(1);
        });
    });
    describe('Failed execution', () => {
        it('should not retry non-retryable errors', async () => {
            const retry = new retry_1.RetryWithBackoff({ maxAttempts: 3 });
            const mockFn = jest.fn().mockRejectedValue(new Error('AUTHENTICATION_FAILED'));
            await expect(retry.execute(mockFn, 'test')).rejects.toThrow('AUTHENTICATION_FAILED');
            expect(mockFn).toHaveBeenCalledTimes(1); // Should not retry
        });
    });
    describe('Error detection', () => {
        it('should detect retryable errors by message', () => {
            const retry = new retry_1.RetryWithBackoff();
            const error = new Error('NETWORK_ERROR occurred');
            // Test the private method through reflection
            const isRetryable = retry.isRetryable(error);
            expect(isRetryable).toBe(true);
        });
        it('should detect retryable errors by code', () => {
            const retry = new retry_1.RetryWithBackoff();
            const error = new Error('Connection failed');
            error.code = 'ECONNABORTED';
            // Test the private method through reflection
            const isRetryable = retry.isRetryable(error);
            expect(isRetryable).toBe(true);
        });
        it('should not retry non-retryable errors', () => {
            const retry = new retry_1.RetryWithBackoff();
            const error = new Error('AUTHENTICATION_FAILED');
            // Test the private method through reflection
            const isRetryable = retry.isRetryable(error);
            expect(isRetryable).toBe(false);
        });
    });
    describe('executeWithResult', () => {
        it('should return detailed result on success', async () => {
            const retry = new retry_1.RetryWithBackoff();
            const mockFn = jest.fn().mockResolvedValue('success');
            const result = await retry.executeWithResult(mockFn, 'test');
            expect(result.success).toBe(true);
            expect(result.data).toBe('success');
            expect(result.attempts).toBe(1);
            expect(result.totalTime).toBeGreaterThanOrEqual(0);
            expect(result.error).toBeUndefined();
        });
    });
    describe('Pre-configured instances', () => {
        it('should have different configurations for different use cases', () => {
            const defaultConfig = retry_1.defaultRetry.getConfig();
            const quickConfig = retry_1.quickRetry.getConfig();
            const aggressiveConfig = retry_1.aggressiveRetry.getConfig();
            expect(defaultConfig.maxAttempts).toBe(3);
            expect(quickConfig.maxAttempts).toBe(2);
            expect(aggressiveConfig.maxAttempts).toBe(5);
            expect(quickConfig.initialDelay).toBe(500);
            expect(aggressiveConfig.initialDelay).toBe(2000);
        });
    });
    describe('Delay calculation', () => {
        it('should calculate exponential backoff delays', () => {
            const retry = new retry_1.RetryWithBackoff({
                initialDelay: 1000,
                backoffMultiplier: 2,
                maxDelay: 5000
            });
            // Test the private method through reflection
            const delay1 = retry.calculateDelay(1);
            const delay2 = retry.calculateDelay(2);
            const delay3 = retry.calculateDelay(3);
            expect(delay1).toBeGreaterThanOrEqual(1000);
            expect(delay2).toBeGreaterThanOrEqual(2000);
            expect(delay3).toBeGreaterThanOrEqual(4000);
        });
        it('should respect max delay limit', () => {
            const retry = new retry_1.RetryWithBackoff({
                initialDelay: 1000,
                backoffMultiplier: 10, // Very aggressive
                maxDelay: 2000
            });
            // Test the private method through reflection
            const delay = retry.calculateDelay(3);
            expect(delay).toBeLessThanOrEqual(2000 + 1000); // maxDelay + jitter
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxzYXJhaFxcUmVwb3NcXENDSCBBeGNlc3MgSW50ZWxsaWdlbmNlIFZpYmVkXFx0ZXN0c1xcdW5pdFxccmV0cnkudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUVBLHVEQUF1RDtBQUN2RCxJQUFJLENBQUMsSUFBSSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDaEQsTUFBTSxFQUFFO1FBQ04sS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2hCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2pCO0NBQ0YsQ0FBQyxDQUFDLENBQUM7QUFYSixzREFBeUc7QUFhekcsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtJQUNoQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDN0IsRUFBRSxDQUFDLDBEQUEwRCxFQUFFLEdBQUcsRUFBRTtZQUNsRSxNQUFNLEtBQUssR0FBRyxJQUFJLHdCQUFnQixFQUFFLENBQUM7WUFDckMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRWpDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDMUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsaURBQWlELEVBQUUsR0FBRyxFQUFFO1lBQ3pELE1BQU0sS0FBSyxHQUFHLElBQUksd0JBQWdCLENBQUM7Z0JBQ2pDLFdBQVcsRUFBRSxDQUFDO2dCQUNkLFlBQVksRUFBRSxHQUFHO2FBQ2xCLENBQUMsQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUVqQyxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFVBQVU7WUFDL0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVU7UUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNENBQTRDLEVBQUUsR0FBRyxFQUFFO1lBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksd0JBQWdCLEVBQUUsQ0FBQztZQUNyQyxLQUFLLENBQUMsWUFBWSxDQUFDLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFeEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7UUFDcEMsRUFBRSxDQUFDLDZDQUE2QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzNELE1BQU0sS0FBSyxHQUFHLElBQUksd0JBQWdCLEVBQUUsQ0FBQztZQUNyQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFdEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztZQUVuRCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtRQUNoQyxFQUFFLENBQUMsdUNBQXVDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDckQsTUFBTSxLQUFLLEdBQUcsSUFBSSx3QkFBZ0IsQ0FBQyxFQUFFLFdBQVcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7WUFFL0UsTUFBTSxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDckYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsbUJBQW1CO1FBQzlELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLEVBQUUsQ0FBQywyQ0FBMkMsRUFBRSxHQUFHLEVBQUU7WUFDbkQsTUFBTSxLQUFLLEdBQUcsSUFBSSx3QkFBZ0IsRUFBRSxDQUFDO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFFbEQsNkNBQTZDO1lBQzdDLE1BQU0sV0FBVyxHQUFJLEtBQWEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx3Q0FBd0MsRUFBRSxHQUFHLEVBQUU7WUFDaEQsTUFBTSxLQUFLLEdBQUcsSUFBSSx3QkFBZ0IsRUFBRSxDQUFDO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDNUMsS0FBYSxDQUFDLElBQUksR0FBRyxjQUFjLENBQUM7WUFFckMsNkNBQTZDO1lBQzdDLE1BQU0sV0FBVyxHQUFJLEtBQWEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7WUFDL0MsTUFBTSxLQUFLLEdBQUcsSUFBSSx3QkFBZ0IsRUFBRSxDQUFDO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFFakQsNkNBQTZDO1lBQzdDLE1BQU0sV0FBVyxHQUFJLEtBQWEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtRQUNqQyxFQUFFLENBQUMsMENBQTBDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDeEQsTUFBTSxLQUFLLEdBQUcsSUFBSSx3QkFBZ0IsRUFBRSxDQUFDO1lBQ3JDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUV0RCxNQUFNLE1BQU0sR0FBRyxNQUFNLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFN0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuRCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO1FBQ3hDLEVBQUUsQ0FBQyw4REFBOEQsRUFBRSxHQUFHLEVBQUU7WUFDdEUsTUFBTSxhQUFhLEdBQUcsb0JBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUMvQyxNQUFNLFdBQVcsR0FBRyxrQkFBVSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQzNDLE1BQU0sZ0JBQWdCLEdBQUcsdUJBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUVyRCxNQUFNLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTdDLE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDakMsRUFBRSxDQUFDLDZDQUE2QyxFQUFFLEdBQUcsRUFBRTtZQUNyRCxNQUFNLEtBQUssR0FBRyxJQUFJLHdCQUFnQixDQUFDO2dCQUNqQyxZQUFZLEVBQUUsSUFBSTtnQkFDbEIsaUJBQWlCLEVBQUUsQ0FBQztnQkFDcEIsUUFBUSxFQUFFLElBQUk7YUFDZixDQUFDLENBQUM7WUFFSCw2Q0FBNkM7WUFDN0MsTUFBTSxNQUFNLEdBQUksS0FBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRCxNQUFNLE1BQU0sR0FBSSxLQUFhLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hELE1BQU0sTUFBTSxHQUFJLEtBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFaEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0NBQWdDLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLE1BQU0sS0FBSyxHQUFHLElBQUksd0JBQWdCLENBQUM7Z0JBQ2pDLFlBQVksRUFBRSxJQUFJO2dCQUNsQixpQkFBaUIsRUFBRSxFQUFFLEVBQUUsa0JBQWtCO2dCQUN6QyxRQUFRLEVBQUUsSUFBSTthQUNmLENBQUMsQ0FBQztZQUVILDZDQUE2QztZQUM3QyxNQUFNLEtBQUssR0FBSSxLQUFhLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7UUFDdEUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcc2FyYWhcXFJlcG9zXFxDQ0ggQXhjZXNzIEludGVsbGlnZW5jZSBWaWJlZFxcdGVzdHNcXHVuaXRcXHJldHJ5LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmV0cnlXaXRoQmFja29mZiwgZGVmYXVsdFJldHJ5LCBxdWlja1JldHJ5LCBhZ2dyZXNzaXZlUmV0cnkgfSBmcm9tICcuLi8uLi9zcmMvY29yZS91dGlscy9yZXRyeSc7XHJcblxyXG4vLyBNb2NrIHRoZSBsb2dnZXIgdG8gYXZvaWQgY29uc29sZSBvdXRwdXQgZHVyaW5nIHRlc3RzXHJcbmplc3QubW9jaygnLi4vLi4vc3JjL2NvcmUvbG9nZ2luZy9sb2dnZXInLCAoKSA9PiAoe1xyXG4gIGxvZ2dlcjoge1xyXG4gICAgZGVidWc6IGplc3QuZm4oKSxcclxuICAgIGluZm86IGplc3QuZm4oKSxcclxuICAgIHdhcm46IGplc3QuZm4oKSxcclxuICAgIGVycm9yOiBqZXN0LmZuKCksXHJcbiAgICBmYXRhbDogamVzdC5mbigpXHJcbiAgfVxyXG59KSk7XHJcblxyXG5kZXNjcmliZSgnUmV0cnlXaXRoQmFja29mZicsICgpID0+IHtcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnQ29uZmlndXJhdGlvbicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdXNlIGRlZmF1bHQgY29uZmlndXJhdGlvbiB3aGVuIG5vIGNvbmZpZyBwcm92aWRlZCcsICgpID0+IHtcclxuICAgICAgY29uc3QgcmV0cnkgPSBuZXcgUmV0cnlXaXRoQmFja29mZigpO1xyXG4gICAgICBjb25zdCBjb25maWcgPSByZXRyeS5nZXRDb25maWcoKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChjb25maWcubWF4QXR0ZW1wdHMpLnRvQmUoMyk7XHJcbiAgICAgIGV4cGVjdChjb25maWcuaW5pdGlhbERlbGF5KS50b0JlKDEwMDApO1xyXG4gICAgICBleHBlY3QoY29uZmlnLm1heERlbGF5KS50b0JlKDEwMDAwKTtcclxuICAgICAgZXhwZWN0KGNvbmZpZy5iYWNrb2ZmTXVsdGlwbGllcikudG9CZSgyKTtcclxuICAgICAgZXhwZWN0KGNvbmZpZy5yZXRyeWFibGVFcnJvcnMpLnRvQ29udGFpbignTkVUV09SS19FUlJPUicpO1xyXG4gICAgICBleHBlY3QoY29uZmlnLnJldHJ5YWJsZUVycm9ycykudG9Db250YWluKCdUSU1FT1VUJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIG1lcmdlIGN1c3RvbSBjb25maWd1cmF0aW9uIHdpdGggZGVmYXVsdHMnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJldHJ5ID0gbmV3IFJldHJ5V2l0aEJhY2tvZmYoe1xyXG4gICAgICAgIG1heEF0dGVtcHRzOiA1LFxyXG4gICAgICAgIGluaXRpYWxEZWxheTogNTAwXHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCBjb25maWcgPSByZXRyeS5nZXRDb25maWcoKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChjb25maWcubWF4QXR0ZW1wdHMpLnRvQmUoNSk7XHJcbiAgICAgIGV4cGVjdChjb25maWcuaW5pdGlhbERlbGF5KS50b0JlKDUwMCk7XHJcbiAgICAgIGV4cGVjdChjb25maWcubWF4RGVsYXkpLnRvQmUoMTAwMDApOyAvLyBEZWZhdWx0XHJcbiAgICAgIGV4cGVjdChjb25maWcuYmFja29mZk11bHRpcGxpZXIpLnRvQmUoMik7IC8vIERlZmF1bHRcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGNvbmZpZ3VyYXRpb24gYWZ0ZXIgY3JlYXRpb24nLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJldHJ5ID0gbmV3IFJldHJ5V2l0aEJhY2tvZmYoKTtcclxuICAgICAgcmV0cnkudXBkYXRlQ29uZmlnKHsgbWF4QXR0ZW1wdHM6IDEwIH0pO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHJldHJ5LmdldENvbmZpZygpLm1heEF0dGVtcHRzKS50b0JlKDEwKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnU3VjY2Vzc2Z1bCBleGVjdXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiByZXN1bHQgaW1tZWRpYXRlbHkgb24gc3VjY2VzcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcmV0cnkgPSBuZXcgUmV0cnlXaXRoQmFja29mZigpO1xyXG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ3N1Y2Nlc3MnKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJldHJ5LmV4ZWN1dGUobW9ja0ZuLCAndGVzdCcpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSgnc3VjY2VzcycpO1xyXG4gICAgICBleHBlY3QobW9ja0ZuKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0ZhaWxlZCBleGVjdXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIG5vdCByZXRyeSBub24tcmV0cnlhYmxlIGVycm9ycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcmV0cnkgPSBuZXcgUmV0cnlXaXRoQmFja29mZih7IG1heEF0dGVtcHRzOiAzIH0pO1xyXG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdBVVRIRU5USUNBVElPTl9GQUlMRUQnKSk7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBleHBlY3QocmV0cnkuZXhlY3V0ZShtb2NrRm4sICd0ZXN0JykpLnJlamVjdHMudG9UaHJvdygnQVVUSEVOVElDQVRJT05fRkFJTEVEJyk7XHJcbiAgICAgIGV4cGVjdChtb2NrRm4pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTsgLy8gU2hvdWxkIG5vdCByZXRyeVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdFcnJvciBkZXRlY3Rpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGRldGVjdCByZXRyeWFibGUgZXJyb3JzIGJ5IG1lc3NhZ2UnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJldHJ5ID0gbmV3IFJldHJ5V2l0aEJhY2tvZmYoKTtcclxuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ05FVFdPUktfRVJST1Igb2NjdXJyZWQnKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRlc3QgdGhlIHByaXZhdGUgbWV0aG9kIHRocm91Z2ggcmVmbGVjdGlvblxyXG4gICAgICBjb25zdCBpc1JldHJ5YWJsZSA9IChyZXRyeSBhcyBhbnkpLmlzUmV0cnlhYmxlKGVycm9yKTtcclxuICAgICAgZXhwZWN0KGlzUmV0cnlhYmxlKS50b0JlKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBkZXRlY3QgcmV0cnlhYmxlIGVycm9ycyBieSBjb2RlJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXRyeSA9IG5ldyBSZXRyeVdpdGhCYWNrb2ZmKCk7XHJcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdDb25uZWN0aW9uIGZhaWxlZCcpO1xyXG4gICAgICAoZXJyb3IgYXMgYW55KS5jb2RlID0gJ0VDT05OQUJPUlRFRCc7XHJcbiAgICAgIFxyXG4gICAgICAvLyBUZXN0IHRoZSBwcml2YXRlIG1ldGhvZCB0aHJvdWdoIHJlZmxlY3Rpb25cclxuICAgICAgY29uc3QgaXNSZXRyeWFibGUgPSAocmV0cnkgYXMgYW55KS5pc1JldHJ5YWJsZShlcnJvcik7XHJcbiAgICAgIGV4cGVjdChpc1JldHJ5YWJsZSkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgbm90IHJldHJ5IG5vbi1yZXRyeWFibGUgZXJyb3JzJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXRyeSA9IG5ldyBSZXRyeVdpdGhCYWNrb2ZmKCk7XHJcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdBVVRIRU5USUNBVElPTl9GQUlMRUQnKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRlc3QgdGhlIHByaXZhdGUgbWV0aG9kIHRocm91Z2ggcmVmbGVjdGlvblxyXG4gICAgICBjb25zdCBpc1JldHJ5YWJsZSA9IChyZXRyeSBhcyBhbnkpLmlzUmV0cnlhYmxlKGVycm9yKTtcclxuICAgICAgZXhwZWN0KGlzUmV0cnlhYmxlKS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZXhlY3V0ZVdpdGhSZXN1bHQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBkZXRhaWxlZCByZXN1bHQgb24gc3VjY2VzcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcmV0cnkgPSBuZXcgUmV0cnlXaXRoQmFja29mZigpO1xyXG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ3N1Y2Nlc3MnKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJldHJ5LmV4ZWN1dGVXaXRoUmVzdWx0KG1vY2tGbiwgJ3Rlc3QnKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0JlKCdzdWNjZXNzJyk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQuYXR0ZW1wdHMpLnRvQmUoMSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQudG90YWxUaW1lKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xyXG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ1ByZS1jb25maWd1cmVkIGluc3RhbmNlcycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgaGF2ZSBkaWZmZXJlbnQgY29uZmlndXJhdGlvbnMgZm9yIGRpZmZlcmVudCB1c2UgY2FzZXMnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGRlZmF1bHRDb25maWcgPSBkZWZhdWx0UmV0cnkuZ2V0Q29uZmlnKCk7XHJcbiAgICAgIGNvbnN0IHF1aWNrQ29uZmlnID0gcXVpY2tSZXRyeS5nZXRDb25maWcoKTtcclxuICAgICAgY29uc3QgYWdncmVzc2l2ZUNvbmZpZyA9IGFnZ3Jlc3NpdmVSZXRyeS5nZXRDb25maWcoKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChkZWZhdWx0Q29uZmlnLm1heEF0dGVtcHRzKS50b0JlKDMpO1xyXG4gICAgICBleHBlY3QocXVpY2tDb25maWcubWF4QXR0ZW1wdHMpLnRvQmUoMik7XHJcbiAgICAgIGV4cGVjdChhZ2dyZXNzaXZlQ29uZmlnLm1heEF0dGVtcHRzKS50b0JlKDUpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHF1aWNrQ29uZmlnLmluaXRpYWxEZWxheSkudG9CZSg1MDApO1xyXG4gICAgICBleHBlY3QoYWdncmVzc2l2ZUNvbmZpZy5pbml0aWFsRGVsYXkpLnRvQmUoMjAwMCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0RlbGF5IGNhbGN1bGF0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjYWxjdWxhdGUgZXhwb25lbnRpYWwgYmFja29mZiBkZWxheXMnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJldHJ5ID0gbmV3IFJldHJ5V2l0aEJhY2tvZmYoe1xyXG4gICAgICAgIGluaXRpYWxEZWxheTogMTAwMCxcclxuICAgICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcclxuICAgICAgICBtYXhEZWxheTogNTAwMFxyXG4gICAgICB9KTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRlc3QgdGhlIHByaXZhdGUgbWV0aG9kIHRocm91Z2ggcmVmbGVjdGlvblxyXG4gICAgICBjb25zdCBkZWxheTEgPSAocmV0cnkgYXMgYW55KS5jYWxjdWxhdGVEZWxheSgxKTtcclxuICAgICAgY29uc3QgZGVsYXkyID0gKHJldHJ5IGFzIGFueSkuY2FsY3VsYXRlRGVsYXkoMik7XHJcbiAgICAgIGNvbnN0IGRlbGF5MyA9IChyZXRyeSBhcyBhbnkpLmNhbGN1bGF0ZURlbGF5KDMpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KGRlbGF5MSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgxMDAwKTtcclxuICAgICAgZXhwZWN0KGRlbGF5MikudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgyMDAwKTtcclxuICAgICAgZXhwZWN0KGRlbGF5MykudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg0MDAwKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmVzcGVjdCBtYXggZGVsYXkgbGltaXQnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJldHJ5ID0gbmV3IFJldHJ5V2l0aEJhY2tvZmYoe1xyXG4gICAgICAgIGluaXRpYWxEZWxheTogMTAwMCxcclxuICAgICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMTAsIC8vIFZlcnkgYWdncmVzc2l2ZVxyXG4gICAgICAgIG1heERlbGF5OiAyMDAwXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgLy8gVGVzdCB0aGUgcHJpdmF0ZSBtZXRob2QgdGhyb3VnaCByZWZsZWN0aW9uXHJcbiAgICAgIGNvbnN0IGRlbGF5ID0gKHJldHJ5IGFzIGFueSkuY2FsY3VsYXRlRGVsYXkoMyk7XHJcbiAgICAgIGV4cGVjdChkZWxheSkudG9CZUxlc3NUaGFuT3JFcXVhbCgyMDAwICsgMTAwMCk7IC8vIG1heERlbGF5ICsgaml0dGVyXHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==