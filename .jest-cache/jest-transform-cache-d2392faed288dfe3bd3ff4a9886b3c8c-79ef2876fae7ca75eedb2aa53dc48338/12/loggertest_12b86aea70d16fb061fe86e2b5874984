e0b306664792bb5abb88612301f76810
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logger_1 = require("../../src/core/logging/logger");
// Mock console methods
const originalConsole = {
    log: console.log,
    error: console.error,
    warn: console.warn
};
beforeAll(() => {
    // Mock console methods
    console.log = jest.fn();
    console.error = jest.fn();
    console.warn = jest.fn();
});
afterAll(() => {
    // Restore console methods
    console.log = originalConsole.log;
    console.error = originalConsole.error;
    console.warn = originalConsole.warn;
});
beforeEach(() => {
    jest.clearAllMocks();
    // Clear log buffer
    if (typeof window !== 'undefined') {
        window.__logBuffer = [];
    }
});
describe('Logger', () => {
    describe('Log Levels', () => {
        it('should log debug messages in development', () => {
            logger_1.logger.debug('Debug message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[DEBUG]'), 'Debug message', { test: 'data' });
        });
        it('should log info messages', () => {
            logger_1.logger.info('Info message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[INFO]'), 'Info message', { test: 'data' });
        });
        it('should log warning messages', () => {
            logger_1.logger.warn('Warning message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[WARN]'), 'Warning message', { test: 'data' });
        });
        it('should log error messages', () => {
            logger_1.logger.error('Error message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[ERROR]'), 'Error message', { test: 'data' });
        });
        it('should log fatal messages', () => {
            logger_1.logger.fatal('Fatal message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[FATAL]'), 'Fatal message', { test: 'data' });
        });
    });
    describe('Component Logging', () => {
        it('should log with component context', () => {
            const componentLogger = logger_1.logger.component('TestComponent');
            componentLogger.info('Component message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[INFO]'), 'Component message', { test: 'data' });
        });
    });
    describe('Action Logging', () => {
        it('should log with action context', () => {
            const actionLogger = logger_1.logger.action('TestAction');
            actionLogger.info('Action message', { test: 'data' });
            expect(console.log).toHaveBeenCalledWith(expect.stringContaining('[INFO]'), 'Action message', { test: 'data' });
        });
    });
    describe('Log Buffer', () => {
        it('should store logs in buffer', () => {
            logger_1.logger.info('Test message', { test: 'data' });
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer).toHaveLength(1);
            expect(buffer[0].message).toBe('Test message');
            expect(buffer[0].meta).toEqual({ test: 'data' });
        });
        it('should limit buffer to 100 entries', () => {
            // Add 101 logs
            for (let i = 0; i < 101; i++) {
                logger_1.logger.info(`Message ${i}`);
            }
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer).toHaveLength(100);
            expect(buffer[0].message).toBe('Message 1'); // First message should be removed
            expect(buffer[99].message).toBe('Message 100');
        });
        it('should clear buffer', () => {
            logger_1.logger.info('Test message');
            expect(logger_1.logger.getLogBuffer()).toHaveLength(1);
            logger_1.logger.clearLogBuffer();
            expect(logger_1.logger.getLogBuffer()).toHaveLength(0);
        });
    });
    describe('Log Export', () => {
        it('should export logs as JSON', () => {
            logger_1.logger.info('Test message', { test: 'data' });
            const exported = logger_1.logger.exportLogs();
            const parsed = JSON.parse(exported);
            expect(parsed).toHaveLength(1);
            expect(parsed[0].message).toBe('Test message');
            expect(parsed[0].meta).toEqual({ test: 'data' });
            expect(parsed[0]).toHaveProperty('timestamp');
            expect(parsed[0]).toHaveProperty('level');
        });
    });
    describe('Context Information', () => {
        it('should include correlation ID', () => {
            // Mock sessionStorage
            Object.defineProperty(window, 'sessionStorage', {
                value: {
                    getItem: jest.fn((key) => {
                        if (key === 'correlationId')
                            return 'test-correlation-id';
                        return null;
                    })
                },
                writable: true
            });
            logger_1.logger.info('Test message');
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer[0].correlationId).toBe('test-correlation-id');
        });
        it('should include user ID', () => {
            // Mock sessionStorage
            Object.defineProperty(window, 'sessionStorage', {
                value: {
                    getItem: jest.fn((key) => {
                        if (key === 'userId')
                            return 'test-user-id';
                        return null;
                    })
                },
                writable: true
            });
            logger_1.logger.info('Test message');
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer[0].userId).toBe('test-user-id');
        });
        it('should include session ID', () => {
            // Mock sessionStorage
            Object.defineProperty(window, 'sessionStorage', {
                value: {
                    getItem: jest.fn((key) => {
                        if (key === 'sessionId')
                            return 'test-session-id';
                        return null;
                    })
                },
                writable: true
            });
            logger_1.logger.info('Test message');
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer[0].sessionId).toBe('test-session-id');
        });
    });
    describe('Console Colors', () => {
        it('should use correct colors for different log levels', () => {
            const spy = jest.spyOn(console, 'log');
            logger_1.logger.debug('Debug message');
            logger_1.logger.info('Info message');
            logger_1.logger.warn('Warning message');
            logger_1.logger.error('Error message');
            logger_1.logger.fatal('Fatal message');
            expect(spy).toHaveBeenCalledWith(expect.stringContaining('[DEBUG]'), expect.stringContaining('color: gray'), 'Debug message', '');
            expect(spy).toHaveBeenCalledWith(expect.stringContaining('[INFO]'), expect.stringContaining('color: blue'), 'Info message', '');
            expect(spy).toHaveBeenCalledWith(expect.stringContaining('[WARN]'), expect.stringContaining('color: orange'), 'Warning message', '');
            expect(spy).toHaveBeenCalledWith(expect.stringContaining('[ERROR]'), expect.stringContaining('color: red'), 'Error message', '');
            expect(spy).toHaveBeenCalledWith(expect.stringContaining('[FATAL]'), expect.stringContaining('color: darkred'), 'Fatal message', '');
        });
    });
    describe('Global Access', () => {
        it('should be available on window object', () => {
            expect(window.__logger).toBeDefined();
            expect(window.__logger).toBe(logger_1.logger);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxzYXJhaFxcUmVwb3NcXENDSCBBeGNlc3MgSW50ZWxsaWdlbmNlIFZpYmVkXFx0ZXN0c1xcdW5pdFxcbG9nZ2VyLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwwREFBaUU7QUFFakUsdUJBQXVCO0FBQ3ZCLE1BQU0sZUFBZSxHQUFHO0lBQ3BCLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRztJQUNoQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7SUFDcEIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO0NBQ3JCLENBQUM7QUFFRixTQUFTLENBQUMsR0FBRyxFQUFFO0lBQ1gsdUJBQXVCO0lBQ3ZCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ3hCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzFCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQzdCLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLEdBQUcsRUFBRTtJQUNWLDBCQUEwQjtJQUMxQixPQUFPLENBQUMsR0FBRyxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUM7SUFDbEMsT0FBTyxDQUFDLEtBQUssR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDO0lBQ3RDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQztBQUN4QyxDQUFDLENBQUMsQ0FBQztBQUVILFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDWixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsbUJBQW1CO0lBQ25CLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxFQUFFLENBQUM7UUFDaEMsTUFBTSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDNUIsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7SUFDcEIsUUFBUSxDQUFDLFlBQVksRUFB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LGVBQWUsQ0FBQyxFQUN4QyxpQkFBaUIsRUFDakIsRUFBRSxDQUNMLENBQUM7WUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzVCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsRUFDbEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxFQUNyQyxlQUFlLEVBQ2YsRUFBRSxDQUNMLENBQUM7WUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzVCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsRUFDbEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLEVBQ3pDLGVBQWUsRUFDZixFQUFFLENBQ0wsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtRQUMzQixFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBTSxDQUFDLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcc2FyYWhcXFJlcG9zXFxDQ0ggQXhjZXNzIEludGVsbGlnZW5jZSBWaWJlZFxcdGVzdHNcXHVuaXRcXGxvZ2dlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvZ2dlciwgTG9nTGV2ZWwgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9sb2dnaW5nL2xvZ2dlcic7XHJcblxyXG4vLyBNb2NrIGNvbnNvbGUgbWV0aG9kc1xyXG5jb25zdCBvcmlnaW5hbENvbnNvbGUgPSB7XHJcbiAgICBsb2c6IGNvbnNvbGUubG9nLFxyXG4gICAgZXJyb3I6IGNvbnNvbGUuZXJyb3IsXHJcbiAgICB3YXJuOiBjb25zb2xlLndhcm5cclxufTtcclxuXHJcbmJlZm9yZUFsbCgoKSA9PiB7XHJcbiAgICAvLyBNb2NrIGNvbnNvbGUgbWV0aG9kc1xyXG4gICAgY29uc29sZS5sb2cgPSBqZXN0LmZuKCk7XHJcbiAgICBjb25zb2xlLmVycm9yID0gamVzdC5mbigpO1xyXG4gICAgY29uc29sZS53YXJuID0gamVzdC5mbigpO1xyXG59KTtcclxuXHJcbmFmdGVyQWxsKCgpID0+IHtcclxuICAgIC8vIFJlc3RvcmUgY29uc29sZSBtZXRob2RzXHJcbiAgICBjb25zb2xlLmxvZyA9IG9yaWdpbmFsQ29uc29sZS5sb2c7XHJcbiAgICBjb25zb2xlLmVycm9yID0gb3JpZ2luYWxDb25zb2xlLmVycm9yO1xyXG4gICAgY29uc29sZS53YXJuID0gb3JpZ2luYWxDb25zb2xlLndhcm47XHJcbn0pO1xyXG5cclxuYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgIC8vIENsZWFyIGxvZyBidWZmZXJcclxuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgIHdpbmRvdy5fX2xvZ0J1ZmZlciA9IFtdO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbmRlc2NyaWJlKCdMb2dnZXInLCAoKSA9PiB7XHJcbiAgICBkZXNjcmliZSgnTG9nIExldmVscycsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGxvZyBkZWJ1ZyBtZXNzYWdlcyBpbiBkZXZlbG9wbWVudCcsICgpID0+IHtcclxuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdEZWJ1ZyBtZXNzYWdlJywgeyB0ZXN0OiAnZGF0YScgfSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChjb25zb2xlLmxvZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnW0RFQlVHXScpLFxyXG4gICAgICAgICAgICAgICAgJ0RlYnVnIG1lc3NhZ2UnLFxyXG4gICAgICAgICAgICAgICAgeyB0ZXN0OiAnZGF0YScgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGxvZyBpbmZvIG1lc3NhZ2VzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnSW5mbyBtZXNzYWdlJywgeyB0ZXN0OiAnZGF0YScgfSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChjb25zb2xlLmxvZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnW0lORk9dJyksXHJcbiAgICAgICAgICAgICAgICAnSW5mbyBtZXNzYWdlJyxcclxuICAgICAgICAgICAgICAgIHsgdGVzdDogJ2RhdGEnIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBsb2cgd2FybmluZyBtZXNzYWdlcycsICgpID0+IHtcclxuICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ1dhcm5pbmcgbWVzc2FnZScsIHsgdGVzdDogJ2RhdGEnIH0pO1xyXG4gICAgICAgICAgICBleHBlY3QoY29uc29sZS5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1tXQVJOXScpLFxyXG4gICAgICAgICAgICAgICAgJ1dhcm5pbmcgbWVzc2FnZScsXHJcbiAgICAgICAgICAgICAgICB7IHRlc3Q6ICdkYXRhJyB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgbG9nIGVycm9yIG1lc3NhZ2VzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuICAgICAgICAgICAgZXhwZWN0KGNvbnNvbGUubG9nKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdbRVJST1JdJyksXHJcbiAgICAgICAgICAgICAgICAnRXJyb3IgbWVzc2FnZScsXHJcbiAgICAgICAgICAgICAgICB7IHRlc3Q6ICdkYXRhJyB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgbG9nIGZhdGFsIG1lc3NhZ2VzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBsb2dnZXIuZmF0YWwoJ0ZhdGFsIG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuICAgICAgICAgICAgZXhwZWN0KGNvbnNvbGUubG9nKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdbRkFUQUxdJyksXHJcbiAgICAgICAgICAgICAgICAnRmF0YWwgbWVzc2FnZScsXHJcbiAgICAgICAgICAgICAgICB7IHRlc3Q6ICdkYXRhJyB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnQ29tcG9uZW50IExvZ2dpbmcnLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCBsb2cgd2l0aCBjb21wb25lbnQgY29udGV4dCcsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29tcG9uZW50TG9nZ2VyID0gbG9nZ2VyLmNvbXBvbmVudCgnVGVzdENvbXBvbmVudCcpO1xyXG4gICAgICAgICAgICBjb21wb25lbnRMb2dnZXIuaW5mbygnQ29tcG9uZW50IG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChjb25zb2xlLmxvZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnW0lORk9dJyksXHJcbiAgICAgICAgICAgICAgICAnQ29tcG9uZW50IG1lc3NhZ2UnLFxyXG4gICAgICAgICAgICAgICAgeyB0ZXN0OiAnZGF0YScgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0FjdGlvbiBMb2dnaW5nJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgbG9nIHdpdGggYWN0aW9uIGNvbnRleHQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGlvbkxvZ2dlciA9IGxvZ2dlci5hY3Rpb24oJ1Rlc3RBY3Rpb24nKTtcclxuICAgICAgICAgICAgYWN0aW9uTG9nZ2VyLmluZm8oJ0FjdGlvbiBtZXNzYWdlJywgeyB0ZXN0OiAnZGF0YScgfSk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QoY29uc29sZS5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1tJTkZPXScpLFxyXG4gICAgICAgICAgICAgICAgJ0FjdGlvbiBtZXNzYWdlJyxcclxuICAgICAgICAgICAgICAgIHsgdGVzdDogJ2RhdGEnIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdMb2cgQnVmZmVyJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgc3RvcmUgbG9ncyBpbiBidWZmZXInLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IGxvZ2dlci5nZXRMb2dCdWZmZXIoKTtcclxuICAgICAgICAgICAgZXhwZWN0KGJ1ZmZlcikudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgICAgICAgICBleHBlY3QoYnVmZmVyWzBdLm1lc3NhZ2UpLnRvQmUoJ1Rlc3QgbWVzc2FnZScpO1xyXG4gICAgICAgICAgICBleHBlY3QoYnVmZmVyWzBdLm1ldGEpLnRvRXF1YWwoeyB0ZXN0OiAnZGF0YScgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgbGltaXQgYnVmZmVyIHRvIDEwMCBlbnRyaWVzJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBBZGQgMTAxIGxvZ3NcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDE7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oYE1lc3NhZ2UgJHtpfWApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBidWZmZXIgPSBsb2dnZXIuZ2V0TG9nQnVmZmVyKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChidWZmZXIpLnRvSGF2ZUxlbmd0aCgxMDApO1xyXG4gICAgICAgICAgICBleHBlY3QoYnVmZmVyWzBdLm1lc3NhZ2UpLnRvQmUoJ01lc3NhZ2UgMScpOyAvLyBGaXJzdCBtZXNzYWdlIHNob3VsZCBiZSByZW1vdmVkXHJcbiAgICAgICAgICAgIGV4cGVjdChidWZmZXJbOTldLm1lc3NhZ2UpLnRvQmUoJ01lc3NhZ2UgMTAwJyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgY2xlYXIgYnVmZmVyJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnVGVzdCBtZXNzYWdlJyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChsb2dnZXIuZ2V0TG9nQnVmZmVyKCkpLnRvSGF2ZUxlbmd0aCgxKTtcclxuXHJcbiAgICAgICAgICAgIGxvZ2dlci5jbGVhckxvZ0J1ZmZlcigpO1xyXG4gICAgICAgICAgICBleHBlY3QobG9nZ2VyLmdldExvZ0J1ZmZlcigpKS50b0hhdmVMZW5ndGgoMCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnTG9nIEV4cG9ydCcsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGV4cG9ydCBsb2dzIGFzIEpTT04nLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVkID0gbG9nZ2VyLmV4cG9ydExvZ3MoKTtcclxuICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShleHBvcnRlZCk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QocGFyc2VkKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRbMF0ubWVzc2FnZSkudG9CZSgnVGVzdCBtZXNzYWdlJyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChwYXJzZWRbMF0ubWV0YSkudG9FcXVhbCh7IHRlc3Q6ICdkYXRhJyB9KTtcclxuICAgICAgICAgICAgZXhwZWN0KHBhcnNlZFswXSkudG9IYXZlUHJvcGVydHkoJ3RpbWVzdGFtcCcpO1xyXG4gICAgICAgICAgICBleHBlY3QocGFyc2VkWzBdKS50b0hhdmVQcm9wZXJ0eSgnbGV2ZWwnKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdDb250ZXh0IEluZm9ybWF0aW9uJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgaW5jbHVkZSBjb3JyZWxhdGlvbiBJRCcsICgpID0+IHtcclxuICAgICAgICAgICAgLy8gTW9jayBzZXNzaW9uU3RvcmFnZVxyXG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAnc2Vzc2lvblN0b3JhZ2UnLCB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZToge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldEl0ZW06IGplc3QuZm4oKGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnY29ycmVsYXRpb25JZCcpIHJldHVybiAndGVzdC1jb3JyZWxhdGlvbi1pZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnVGVzdCBtZXNzYWdlJyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBidWZmZXIgPSBsb2dnZXIuZ2V0TG9nQnVmZmVyKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChidWZmZXJbMF0uY29ycmVsYXRpb25JZCkudG9CZSgndGVzdC1jb3JyZWxhdGlvbi1pZCcpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgdXNlciBJRCcsICgpID0+IHtcclxuICAgICAgICAgICAgLy8gTW9jayBzZXNzaW9uU3RvcmFnZVxyXG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAnc2Vzc2lvblN0b3JhZ2UnLCB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZToge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldEl0ZW06IGplc3QuZm4oKGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAndXNlcklkJykgcmV0dXJuICd0ZXN0LXVzZXItaWQnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ1Rlc3QgbWVzc2FnZScpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgYnVmZmVyID0gbG9nZ2VyLmdldExvZ0J1ZmZlcigpO1xyXG4gICAgICAgICAgICBleHBlY3QoYnVmZmVyWzBdLnVzZXJJZCkudG9CZSgndGVzdC11c2VyLWlkJyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgaW5jbHVkZSBzZXNzaW9uIElEJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBNb2NrIHNlc3Npb25TdG9yYWdlXHJcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICdzZXNzaW9uU3RvcmFnZScsIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0SXRlbTogamVzdC5mbigoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdzZXNzaW9uSWQnKSByZXR1cm4gJ3Rlc3Qtc2Vzc2lvbi1pZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnVGVzdCBtZXNzYWdlJyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBidWZmZXIgPSBsb2dnZXIuZ2V0TG9nQnVmZmVyKCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChidWZmZXJbMF0uc2Vzc2lvbklkKS50b0JlKCd0ZXN0LXNlc3Npb24taWQnKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdDb25zb2xlIENvbG9ycycsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIHVzZSBjb3JyZWN0IGNvbG9ycyBmb3IgZGlmZmVyZW50IGxvZyBsZXZlbHMnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ2xvZycpO1xyXG5cclxuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdEZWJ1ZyBtZXNzYWdlJyk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdJbmZvIG1lc3NhZ2UnKTtcclxuICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ1dhcm5pbmcgbWVzc2FnZScpO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIG1lc3NhZ2UnKTtcclxuICAgICAgICAgICAgbG9nZ2VyLmZhdGFsKCdGYXRhbCBtZXNzYWdlJyk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdbREVCVUddJyksXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnY29sb3I6IGdyYXknKSxcclxuICAgICAgICAgICAgICAgICdEZWJ1ZyBtZXNzYWdlJyxcclxuICAgICAgICAgICAgICAgICcnXHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdbSU5GT10nKSxcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdjb2xvcjogYmx1ZScpLFxyXG4gICAgICAgICAgICAgICAgJ0luZm8gbWVzc2FnZScsXHJcbiAgICAgICAgICAgICAgICAnJ1xyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KHNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnW1dBUk5dJyksXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnY29sb3I6IG9yYW5nZScpLFxyXG4gICAgICAgICAgICAgICAgJ1dhcm5pbmcgbWVzc2FnZScsXHJcbiAgICAgICAgICAgICAgICAnJ1xyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KHNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnW0VSUk9SXScpLFxyXG4gICAgICAgICAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ2NvbG9yOiByZWQnKSxcclxuICAgICAgICAgICAgICAgICdFcnJvciBtZXNzYWdlJyxcclxuICAgICAgICAgICAgICAgICcnXHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdbRkFUQUxdJyksXHJcbiAgICAgICAgICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnY29sb3I6IGRhcmtyZWQnKSxcclxuICAgICAgICAgICAgICAgICdGYXRhbCBtZXNzYWdlJyxcclxuICAgICAgICAgICAgICAgICcnXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnR2xvYmFsIEFjY2VzcycsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGJlIGF2YWlsYWJsZSBvbiB3aW5kb3cgb2JqZWN0JywgKCkgPT4ge1xyXG4gICAgICAgICAgICBleHBlY3Qod2luZG93Ll9fbG9nZ2VyKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICAgICAgICBleHBlY3Qod2luZG93Ll9fbG9nZ2VyKS50b0JlKGxvZ2dlcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==