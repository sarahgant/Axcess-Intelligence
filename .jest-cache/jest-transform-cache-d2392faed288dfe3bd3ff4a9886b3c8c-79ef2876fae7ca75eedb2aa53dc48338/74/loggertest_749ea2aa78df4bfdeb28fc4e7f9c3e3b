8332251f38b86c23f35966f13a9ca5d7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logger_1 = require("../../src/core/logging/logger");
// Mock console methods
const originalConsole = {
    log: console.log,
    error: console.error,
    warn: console.warn
};
beforeAll(() => {
    // Mock console methods
    console.log = jest.fn();
    console.error = jest.fn();
    console.warn = jest.fn();
});
afterAll(() => {
    // Restore console methods
    console.log = originalConsole.log;
    console.error = originalConsole.error;
    console.warn = originalConsole.warn;
});
beforeEach(() => {
    jest.clearAllMocks();
    // Clear log buffer
    if (typeof window !== 'undefined') {
        window.__logBuffer = [];
    }
});
describe('Logger', () => {
    describe('Log Buffer', () => {
        it('should store logs in buffer', () => {
            logger_1.logger.info('Test message', { test: 'data' });
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer).toHaveLength(1);
            expect(buffer[0].message).toBe('Test message');
            expect(buffer[0].meta).toEqual({ test: 'data' });
        });
        it('should limit buffer to 100 entries', () => {
            // Add 101 logs
            for (let i = 0; i < 101; i++) {
                logger_1.logger.info(`Message ${i}`);
            }
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer).toHaveLength(100);
            expect(buffer[0].message).toBe('Message 1'); // First message should be removed
            expect(buffer[99].message).toBe('Message 100');
        });
        it('should clear buffer', () => {
            logger_1.logger.info('Test message');
            expect(logger_1.logger.getLogBuffer()).toHaveLength(1);
            logger_1.logger.clearLogBuffer();
            expect(logger_1.logger.getLogBuffer()).toHaveLength(0);
        });
    });
    describe('Log Export', () => {
        it('should export logs as JSON', () => {
            logger_1.logger.info('Test message', { test: 'data' });
            const exported = logger_1.logger.exportLogs();
            const parsed = JSON.parse(exported);
            expect(parsed).toHaveLength(1);
            expect(parsed[0].message).toBe('Test message');
            expect(parsed[0].meta).toEqual({ test: 'data' });
            expect(parsed[0]).toHaveProperty('timestamp');
            expect(parsed[0]).toHaveProperty('level');
        });
    });
    describe('Context Information', () => {
        it('should include correlation ID', () => {
            // Mock sessionStorage
            Object.defineProperty(window, 'sessionStorage', {
                value: {
                    getItem: jest.fn((key) => {
                        if (key === 'correlationId')
                            return 'test-correlation-id';
                        return null;
                    })
                },
                writable: true
            });
            logger_1.logger.info('Test message');
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer[0].correlationId).toBe('test-correlation-id');
        });
        it('should include user ID', () => {
            // Mock sessionStorage
            Object.defineProperty(window, 'sessionStorage', {
                value: {
                    getItem: jest.fn((key) => {
                        if (key === 'userId')
                            return 'test-user-id';
                        return null;
                    })
                },
                writable: true
            });
            logger_1.logger.info('Test message');
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer[0].userId).toBe('test-user-id');
        });
        it('should include session ID', () => {
            // Mock sessionStorage
            Object.defineProperty(window, 'sessionStorage', {
                value: {
                    getItem: jest.fn((key) => {
                        if (key === 'sessionId')
                            return 'test-session-id';
                        return null;
                    })
                },
                writable: true
            });
            logger_1.logger.info('Test message');
            const buffer = logger_1.logger.getLogBuffer();
            expect(buffer[0].sessionId).toBe('test-session-id');
        });
    });
    describe('Global Access', () => {
        it('should be available on window object', () => {
            expect(window.__logger).toBeDefined();
            expect(window.__logger).toBe(logger_1.logger);
        });
    });
    describe('Log Levels', () => {
        it('should have correct log level enum values', () => {
            expect(logger_1.LogLevel.DEBUG).toBe(0);
            expect(logger_1.LogLevel.INFO).toBe(1);
            expect(logger_1.LogLevel.WARN).toBe(2);
            expect(logger_1.LogLevel.ERROR).toBe(3);
            expect(logger_1.LogLevel.FATAL).toBe(4);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxzYXJhaFxcUmVwb3NcXENDSCBBeGNlc3MgSW50ZWxsaWdlbmNlIFZpYmVkXFx0ZXN0c1xcdW5pdFxcbG9nZ2VyLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwwREFBaUU7QUFFakUsdUJBQXVCO0FBQ3ZCLE1BQU0sZUFBZSxHQUFHO0lBQ3RCLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRztJQUNoQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7SUFDcEIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO0NBQ25CLENBQUM7QUFFRixTQUFTLENBQUMsR0FBRyxFQUFFO0lBQ2IsdUJBQXVCO0lBQ3ZCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ3hCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzFCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQzNCLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLEdBQUcsRUFBRTtJQUNaLDBCQUEwQjtJQUMxQixPQUFPLENBQUMsR0FBRyxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUM7SUFDbEMsT0FBTyxDQUFDLEtBQUssR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDO0lBQ3RDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQztBQUN0QyxDQUFDLENBQUMsQ0FBQztBQUVILFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsbUJBQW1CO0lBQ25CLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxFQUFFLENBQUM7UUFDbEMsTUFBTSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDMUIsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7SUFDdEIsUUFBUSxDQUFDLFlBQVksRUFB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Q0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtRQUMxQixFQUFFLENBQUMsMkNBQTJDLEVBQUUsR0FBRyxFQUFFO1lBQ25ELE1BQU0sQ0FBQyxpQkFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixNQUFNLENBQUMsaUJBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsTUFBTSxDQUFDLGlCQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLE1BQU0sQ0FBQyxpQkFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixNQUFNLENBQUMsaUJBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcc2FyYWhcXFJlcG9zXFxDQ0ggQXhjZXNzIEludGVsbGlnZW5jZSBWaWJlZFxcdGVzdHNcXHVuaXRcXGxvZ2dlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvZ2dlciwgTG9nTGV2ZWwgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9sb2dnaW5nL2xvZ2dlcic7XHJcblxyXG4vLyBNb2NrIGNvbnNvbGUgbWV0aG9kc1xyXG5jb25zdCBvcmlnaW5hbENvbnNvbGUgPSB7XHJcbiAgbG9nOiBjb25zb2xlLmxvZyxcclxuICBlcnJvcjogY29uc29sZS5lcnJvcixcclxuICB3YXJuOiBjb25zb2xlLndhcm5cclxufTtcclxuXHJcbmJlZm9yZUFsbCgoKSA9PiB7XHJcbiAgLy8gTW9jayBjb25zb2xlIG1ldGhvZHNcclxuICBjb25zb2xlLmxvZyA9IGplc3QuZm4oKTtcclxuICBjb25zb2xlLmVycm9yID0gamVzdC5mbigpO1xyXG4gIGNvbnNvbGUud2FybiA9IGplc3QuZm4oKTtcclxufSk7XHJcblxyXG5hZnRlckFsbCgoKSA9PiB7XHJcbiAgLy8gUmVzdG9yZSBjb25zb2xlIG1ldGhvZHNcclxuICBjb25zb2xlLmxvZyA9IG9yaWdpbmFsQ29uc29sZS5sb2c7XHJcbiAgY29uc29sZS5lcnJvciA9IG9yaWdpbmFsQ29uc29sZS5lcnJvcjtcclxuICBjb25zb2xlLndhcm4gPSBvcmlnaW5hbENvbnNvbGUud2FybjtcclxufSk7XHJcblxyXG5iZWZvcmVFYWNoKCgpID0+IHtcclxuICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAvLyBDbGVhciBsb2cgYnVmZmVyXHJcbiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICB3aW5kb3cuX19sb2dCdWZmZXIgPSBbXTtcclxuICB9XHJcbn0pO1xyXG5cclxuZGVzY3JpYmUoJ0xvZ2dlcicsICgpID0+IHtcclxuICBkZXNjcmliZSgnTG9nIEJ1ZmZlcicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgc3RvcmUgbG9ncyBpbiBidWZmZXInLCAoKSA9PiB7XHJcbiAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGxvZ2dlci5nZXRMb2dCdWZmZXIoKTtcclxuICAgICAgZXhwZWN0KGJ1ZmZlcikudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgICBleHBlY3QoYnVmZmVyWzBdLm1lc3NhZ2UpLnRvQmUoJ1Rlc3QgbWVzc2FnZScpO1xyXG4gICAgICBleHBlY3QoYnVmZmVyWzBdLm1ldGEpLnRvRXF1YWwoeyB0ZXN0OiAnZGF0YScgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGxpbWl0IGJ1ZmZlciB0byAxMDAgZW50cmllcycsICgpID0+IHtcclxuICAgICAgLy8gQWRkIDEwMSBsb2dzXHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTAxOyBpKyspIHtcclxuICAgICAgICBsb2dnZXIuaW5mbyhgTWVzc2FnZSAke2l9YCk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGxvZ2dlci5nZXRMb2dCdWZmZXIoKTtcclxuICAgICAgZXhwZWN0KGJ1ZmZlcikudG9IYXZlTGVuZ3RoKDEwMCk7XHJcbiAgICAgIGV4cGVjdChidWZmZXJbMF0ubWVzc2FnZSkudG9CZSgnTWVzc2FnZSAxJyk7IC8vIEZpcnN0IG1lc3NhZ2Ugc2hvdWxkIGJlIHJlbW92ZWRcclxuICAgICAgZXhwZWN0KGJ1ZmZlcls5OV0ubWVzc2FnZSkudG9CZSgnTWVzc2FnZSAxMDAnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgY2xlYXIgYnVmZmVyJywgKCkgPT4ge1xyXG4gICAgICBsb2dnZXIuaW5mbygnVGVzdCBtZXNzYWdlJyk7XHJcbiAgICAgIGV4cGVjdChsb2dnZXIuZ2V0TG9nQnVmZmVyKCkpLnRvSGF2ZUxlbmd0aCgxKTtcclxuICAgICAgXHJcbiAgICAgIGxvZ2dlci5jbGVhckxvZ0J1ZmZlcigpO1xyXG4gICAgICBleHBlY3QobG9nZ2VyLmdldExvZ0J1ZmZlcigpKS50b0hhdmVMZW5ndGgoMCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0xvZyBFeHBvcnQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGV4cG9ydCBsb2dzIGFzIEpTT04nLCAoKSA9PiB7XHJcbiAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IG1lc3NhZ2UnLCB7IHRlc3Q6ICdkYXRhJyB9KTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGV4cG9ydGVkID0gbG9nZ2VyLmV4cG9ydExvZ3MoKTtcclxuICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShleHBvcnRlZCk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QocGFyc2VkKS50b0hhdmVMZW5ndGgoMSk7XHJcbiAgICAgIGV4cGVjdChwYXJzZWRbMF0ubWVzc2FnZSkudG9CZSgnVGVzdCBtZXNzYWdlJyk7XHJcbiAgICAgIGV4cGVjdChwYXJzZWRbMF0ubWV0YSkudG9FcXVhbCh7IHRlc3Q6ICdkYXRhJyB9KTtcclxuICAgICAgZXhwZWN0KHBhcnNlZFswXSkudG9IYXZlUHJvcGVydHkoJ3RpbWVzdGFtcCcpO1xyXG4gICAgICBleHBlY3QocGFyc2VkWzBdKS50b0hhdmVQcm9wZXJ0eSgnbGV2ZWwnKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnQ29udGV4dCBJbmZvcm1hdGlvbicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSBjb3JyZWxhdGlvbiBJRCcsICgpID0+IHtcclxuICAgICAgLy8gTW9jayBzZXNzaW9uU3RvcmFnZVxyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAnc2Vzc2lvblN0b3JhZ2UnLCB7XHJcbiAgICAgICAgdmFsdWU6IHtcclxuICAgICAgICAgIGdldEl0ZW06IGplc3QuZm4oKGtleSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoa2V5ID09PSAnY29ycmVsYXRpb25JZCcpIHJldHVybiAndGVzdC1jb3JyZWxhdGlvbi1pZCc7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIHdyaXRhYmxlOiB0cnVlXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgbG9nZ2VyLmluZm8oJ1Rlc3QgbWVzc2FnZScpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYnVmZmVyID0gbG9nZ2VyLmdldExvZ0J1ZmZlcigpO1xyXG4gICAgICBleHBlY3QoYnVmZmVyWzBdLmNvcnJlbGF0aW9uSWQpLnRvQmUoJ3Rlc3QtY29ycmVsYXRpb24taWQnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSB1c2VyIElEJywgKCkgPT4ge1xyXG4gICAgICAvLyBNb2NrIHNlc3Npb25TdG9yYWdlXHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICdzZXNzaW9uU3RvcmFnZScsIHtcclxuICAgICAgICB2YWx1ZToge1xyXG4gICAgICAgICAgZ2V0SXRlbTogamVzdC5mbigoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChrZXkgPT09ICd1c2VySWQnKSByZXR1cm4gJ3Rlc3QtdXNlci1pZCc7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIHdyaXRhYmxlOiB0cnVlXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgbG9nZ2VyLmluZm8oJ1Rlc3QgbWVzc2FnZScpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYnVmZmVyID0gbG9nZ2VyLmdldExvZ0J1ZmZlcigpO1xyXG4gICAgICBleHBlY3QoYnVmZmVyWzBdLnVzZXJJZCkudG9CZSgndGVzdC11c2VyLWlkJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGluY2x1ZGUgc2Vzc2lvbiBJRCcsICgpID0+IHtcclxuICAgICAgLy8gTW9jayBzZXNzaW9uU3RvcmFnZVxyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAnc2Vzc2lvblN0b3JhZ2UnLCB7XHJcbiAgICAgICAgdmFsdWU6IHtcclxuICAgICAgICAgIGdldEl0ZW06IGplc3QuZm4oKGtleSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoa2V5ID09PSAnc2Vzc2lvbklkJykgcmV0dXJuICd0ZXN0LXNlc3Npb24taWQnO1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICB3cml0YWJsZTogdHJ1ZVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IG1lc3NhZ2UnKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGxvZ2dlci5nZXRMb2dCdWZmZXIoKTtcclxuICAgICAgZXhwZWN0KGJ1ZmZlclswXS5zZXNzaW9uSWQpLnRvQmUoJ3Rlc3Qtc2Vzc2lvbi1pZCcpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdHbG9iYWwgQWNjZXNzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBiZSBhdmFpbGFibGUgb24gd2luZG93IG9iamVjdCcsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHdpbmRvdy5fX2xvZ2dlcikudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHdpbmRvdy5fX2xvZ2dlcikudG9CZShsb2dnZXIpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdMb2cgTGV2ZWxzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBoYXZlIGNvcnJlY3QgbG9nIGxldmVsIGVudW0gdmFsdWVzJywgKCkgPT4ge1xyXG4gICAgICBleHBlY3QoTG9nTGV2ZWwuREVCVUcpLnRvQmUoMCk7XHJcbiAgICAgIGV4cGVjdChMb2dMZXZlbC5JTkZPKS50b0JlKDEpO1xyXG4gICAgICBleHBlY3QoTG9nTGV2ZWwuV0FSTikudG9CZSgyKTtcclxuICAgICAgZXhwZWN0KExvZ0xldmVsLkVSUk9SKS50b0JlKDMpO1xyXG4gICAgICBleHBlY3QoTG9nTGV2ZWwuRkFUQUwpLnRvQmUoNCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==