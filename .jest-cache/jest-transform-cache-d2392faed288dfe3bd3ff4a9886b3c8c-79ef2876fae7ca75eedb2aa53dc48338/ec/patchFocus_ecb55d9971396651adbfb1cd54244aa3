753f4cd9190dfd369955b67695bbb3ec
'use strict';

var dispatchEvent = require('../event/dispatchEvent.js');
require('../utils/dataTransfer/Clipboard.js');
var getActiveElement = require('../utils/focus/getActiveElement.js');
require('@testing-library/dom');
const patched = Symbol('patched focus/blur methods');
function patchFocus(HTMLElement) {
  if (HTMLElement.prototype[patched]) {
    return;
  }
  // eslint-disable-next-line @typescript-eslint/unbound-method
  const {
    focus,
    blur
  } = HTMLElement.prototype;
  Object.defineProperties(HTMLElement.prototype, {
    focus: {
      configurable: true,
      get: () => patchedFocus
    },
    blur: {
      configurable: true,
      get: () => patchedBlur
    },
    [patched]: {
      configurable: true,
      get: () => ({
        focus,
        blur
      })
    }
  });
  let activeCall;
  function patchedFocus(options) {
    if (this.ownerDocument.visibilityState !== 'hidden') {
      return focus.call(this, options);
    }
    const blurred = getActiveTarget(this.ownerDocument);
    if (blurred === this) {
      return;
    }
    const thisCall = Symbol('focus call');
    activeCall = thisCall;
    if (blurred) {
      blur.call(blurred);
      dispatchEvent.dispatchDOMEvent(blurred, 'blur', {
        relatedTarget: this
      });
      dispatchEvent.dispatchDOMEvent(blurred, 'focusout', {
        relatedTarget: activeCall === thisCall ? this : null
      });
    }
    if (activeCall === thisCall) {
      focus.call(this, options);
      dispatchEvent.dispatchDOMEvent(this, 'focus', {
        relatedTarget: blurred
      });
    }
    if (activeCall === thisCall) {
      dispatchEvent.dispatchDOMEvent(this, 'focusin', {
        relatedTarget: blurred
      });
    }
  }
  function patchedBlur() {
    if (this.ownerDocument.visibilityState !== 'hidden') {
      return blur.call(this);
    }
    const blurred = getActiveTarget(this.ownerDocument);
    if (blurred !== this) {
      return;
    }
    const thisCall = Symbol('blur call');
    activeCall = thisCall;
    blur.call(this);
    dispatchEvent.dispatchDOMEvent(blurred, 'blur', {
      relatedTarget: null
    });
    dispatchEvent.dispatchDOMEvent(blurred, 'focusout', {
      relatedTarget: null
    });
  }
}
function getActiveTarget(document) {
  const active = getActiveElement.getActiveElement(document);
  return (active === null || active === undefined ? undefined : active.tagName) === 'BODY' ? null : active;
}
function restoreFocus(HTMLElement) {
  if (HTMLElement.prototype[patched]) {
    const {
      focus,
      blur
    } = HTMLElement.prototype[patched];
    Object.defineProperties(HTMLElement.prototype, {
      focus: {
        configurable: true,
        get: () => focus
      },
      blur: {
        configurable: true,
        get: () => blur
      }
    });
  }
}
exports.patchFocus = patchFocus;
exports.restoreFocus = restoreFocus;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkaXNwYXRjaEV2ZW50IiwicmVxdWlyZSIsImdldEFjdGl2ZUVsZW1lbnQiLCJwYXRjaGVkIiwiU3ltYm9sIiwicGF0Y2hGb2N1cyIsIkhUTUxFbGVtZW50IiwicHJvdG90eXBlIiwiZm9jdXMiLCJibHVyIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydGllcyIsImNvbmZpZ3VyYWJsZSIsImdldCIsInBhdGNoZWRGb2N1cyIsInBhdGNoZWRCbHVyIiwiYWN0aXZlQ2FsbCIsIm9wdGlvbnMiLCJvd25lckRvY3VtZW50IiwidmlzaWJpbGl0eVN0YXRlIiwiY2FsbCIsImJsdXJyZWQiLCJnZXRBY3RpdmVUYXJnZXQiLCJ0aGlzQ2FsbCIsImRpc3BhdGNoRE9NRXZlbnQiLCJyZWxhdGVkVGFyZ2V0IiwiZG9jdW1lbnQiLCJhY3RpdmUiLCJ1bmRlZmluZWQiLCJ0YWdOYW1lIiwicmVzdG9yZUZvY3VzIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInBhdGNoRm9jdXMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgZGlzcGF0Y2hFdmVudCA9IHJlcXVpcmUoJy4uL2V2ZW50L2Rpc3BhdGNoRXZlbnQuanMnKTtcbnJlcXVpcmUoJy4uL3V0aWxzL2RhdGFUcmFuc2Zlci9DbGlwYm9hcmQuanMnKTtcbnZhciBnZXRBY3RpdmVFbGVtZW50ID0gcmVxdWlyZSgnLi4vdXRpbHMvZm9jdXMvZ2V0QWN0aXZlRWxlbWVudC5qcycpO1xucmVxdWlyZSgnQHRlc3RpbmctbGlicmFyeS9kb20nKTtcblxuY29uc3QgcGF0Y2hlZCA9IFN5bWJvbCgncGF0Y2hlZCBmb2N1cy9ibHVyIG1ldGhvZHMnKTtcbmZ1bmN0aW9uIHBhdGNoRm9jdXMoSFRNTEVsZW1lbnQpIHtcbiAgICBpZiAoSFRNTEVsZW1lbnQucHJvdG90eXBlW3BhdGNoZWRdKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC91bmJvdW5kLW1ldGhvZFxuICAgIGNvbnN0IHsgZm9jdXMsIGJsdXIgfSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhIVE1MRWxlbWVudC5wcm90b3R5cGUsIHtcbiAgICAgICAgZm9jdXM6IHtcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIGdldDogKCk9PnBhdGNoZWRGb2N1c1xuICAgICAgICB9LFxuICAgICAgICBibHVyOiB7XG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICBnZXQ6ICgpPT5wYXRjaGVkQmx1clxuICAgICAgICB9LFxuICAgICAgICBbcGF0Y2hlZF06IHtcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIGdldDogKCk9Pih7XG4gICAgICAgICAgICAgICAgICAgIGZvY3VzLFxuICAgICAgICAgICAgICAgICAgICBibHVyXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGxldCBhY3RpdmVDYWxsO1xuICAgIGZ1bmN0aW9uIHBhdGNoZWRGb2N1cyhvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm93bmVyRG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlICE9PSAnaGlkZGVuJykge1xuICAgICAgICAgICAgcmV0dXJuIGZvY3VzLmNhbGwodGhpcywgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYmx1cnJlZCA9IGdldEFjdGl2ZVRhcmdldCh0aGlzLm93bmVyRG9jdW1lbnQpO1xuICAgICAgICBpZiAoYmx1cnJlZCA9PT0gdGhpcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRoaXNDYWxsID0gU3ltYm9sKCdmb2N1cyBjYWxsJyk7XG4gICAgICAgIGFjdGl2ZUNhbGwgPSB0aGlzQ2FsbDtcbiAgICAgICAgaWYgKGJsdXJyZWQpIHtcbiAgICAgICAgICAgIGJsdXIuY2FsbChibHVycmVkKTtcbiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQuZGlzcGF0Y2hET01FdmVudChibHVycmVkLCAnYmx1cicsIHtcbiAgICAgICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiB0aGlzXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQuZGlzcGF0Y2hET01FdmVudChibHVycmVkLCAnZm9jdXNvdXQnLCB7XG4gICAgICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogYWN0aXZlQ2FsbCA9PT0gdGhpc0NhbGwgPyB0aGlzIDogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFjdGl2ZUNhbGwgPT09IHRoaXNDYWxsKSB7XG4gICAgICAgICAgICBmb2N1cy5jYWxsKHRoaXMsIG9wdGlvbnMpO1xuICAgICAgICAgICAgZGlzcGF0Y2hFdmVudC5kaXNwYXRjaERPTUV2ZW50KHRoaXMsICdmb2N1cycsIHtcbiAgICAgICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBibHVycmVkXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYWN0aXZlQ2FsbCA9PT0gdGhpc0NhbGwpIHtcbiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQuZGlzcGF0Y2hET01FdmVudCh0aGlzLCAnZm9jdXNpbicsIHtcbiAgICAgICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBibHVycmVkXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBwYXRjaGVkQmx1cigpIHtcbiAgICAgICAgaWYgKHRoaXMub3duZXJEb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgIT09ICdoaWRkZW4nKSB7XG4gICAgICAgICAgICByZXR1cm4gYmx1ci5jYWxsKHRoaXMpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJsdXJyZWQgPSBnZXRBY3RpdmVUYXJnZXQodGhpcy5vd25lckRvY3VtZW50KTtcbiAgICAgICAgaWYgKGJsdXJyZWQgIT09IHRoaXMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0aGlzQ2FsbCA9IFN5bWJvbCgnYmx1ciBjYWxsJyk7XG4gICAgICAgIGFjdGl2ZUNhbGwgPSB0aGlzQ2FsbDtcbiAgICAgICAgYmx1ci5jYWxsKHRoaXMpO1xuICAgICAgICBkaXNwYXRjaEV2ZW50LmRpc3BhdGNoRE9NRXZlbnQoYmx1cnJlZCwgJ2JsdXInLCB7XG4gICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBudWxsXG4gICAgICAgIH0pO1xuICAgICAgICBkaXNwYXRjaEV2ZW50LmRpc3BhdGNoRE9NRXZlbnQoYmx1cnJlZCwgJ2ZvY3Vzb3V0Jywge1xuICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogbnVsbFxuICAgICAgICB9KTtcbiAgICB9XG59XG5mdW5jdGlvbiBnZXRBY3RpdmVUYXJnZXQoZG9jdW1lbnQpIHtcbiAgICBjb25zdCBhY3RpdmUgPSBnZXRBY3RpdmVFbGVtZW50LmdldEFjdGl2ZUVsZW1lbnQoZG9jdW1lbnQpO1xuICAgIHJldHVybiAoYWN0aXZlID09PSBudWxsIHx8IGFjdGl2ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogYWN0aXZlLnRhZ05hbWUpID09PSAnQk9EWScgPyBudWxsIDogYWN0aXZlO1xufVxuZnVuY3Rpb24gcmVzdG9yZUZvY3VzKEhUTUxFbGVtZW50KSB7XG4gICAgaWYgKEhUTUxFbGVtZW50LnByb3RvdHlwZVtwYXRjaGVkXSkge1xuICAgICAgICBjb25zdCB7IGZvY3VzLCBibHVyIH0gPSBIVE1MRWxlbWVudC5wcm90b3R5cGVbcGF0Y2hlZF07XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEhUTUxFbGVtZW50LnByb3RvdHlwZSwge1xuICAgICAgICAgICAgZm9jdXM6IHtcbiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgZ2V0OiAoKT0+Zm9jdXNcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBibHVyOiB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGdldDogKCk9PmJsdXJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5leHBvcnRzLnBhdGNoRm9jdXMgPSBwYXRjaEZvY3VzO1xuZXhwb3J0cy5yZXN0b3JlRm9jdXMgPSByZXN0b3JlRm9jdXM7XG4iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBRVosSUFBSUEsYUFBYSxHQUFHQyxPQUFPLENBQUMsMkJBQTJCLENBQUM7QUFDeERBLE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQztBQUM3QyxJQUFJQyxnQkFBZ0IsR0FBR0QsT0FBTyxDQUFDLG9DQUFvQyxDQUFDO0FBQ3BFQSxPQUFPLENBQUMsc0JBQXNCLENBQUM7QUFFL0IsTUFBTUUsT0FBTyxHQUFHQyxNQUFNLENBQUMsNEJBQTRCLENBQUM7QUFDcEQsU0FBU0MsVUFBVUEsQ0FBQ0MsV0FBVyxFQUFFO0VBQzdCLElBQUlBLFdBQVcsQ0FBQ0MsU0FBUyxDQUFDSixPQUFPLENBQUMsRUFBRTtJQUNoQztFQUNKO0VBQ0E7RUFDQSxNQUFNO0lBQUVLLEtBQUs7SUFBRUM7RUFBSyxDQUFDLEdBQUdILFdBQVcsQ0FBQ0MsU0FBUztFQUM3Q0csTUFBTSxDQUFDQyxnQkFBZ0IsQ0FBQ0wsV0FBVyxDQUFDQyxTQUFTLEVBQUU7SUFDM0NDLEtBQUssRUFBRTtNQUNISSxZQUFZLEVBQUUsSUFBSTtNQUNsQkMsR0FBRyxFQUFFQSxDQUFBLEtBQUlDO0lBQ2IsQ0FBQztJQUNETCxJQUFJLEVBQUU7TUFDRkcsWUFBWSxFQUFFLElBQUk7TUFDbEJDLEdBQUcsRUFBRUEsQ0FBQSxLQUFJRTtJQUNiLENBQUM7SUFDRCxDQUFDWixPQUFPLEdBQUc7TUFDUFMsWUFBWSxFQUFFLElBQUk7TUFDbEJDLEdBQUcsRUFBRUEsQ0FBQSxNQUFLO1FBQ0ZM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